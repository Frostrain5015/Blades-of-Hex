<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Blades of Hex</title>
    <style>
        body {  margin: 0; 
                padding: 0;
                min-height: 100vh;
                height:100vh;
                overflow: hidden;
                background-image: url("bg.jpg");
                background-repeat: no-repeat;
                background-size: cover;
                background-attachment: fixed;
        }
        #gameCanvas { background: transparent; 
            display: block; 
            margin: 20px auto 20px 250px;
        }
        #gameUI { 
            color: white; 
            font-family: Arial; 
            padding: 10px 20px; 
            position: absolute;
        }

        .turn-display {
            font-size: 36px;
            top: 230px;
            left: 150px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #ffd700;
            text-shadow: 0 0 8px #000;
        }
        .turn-display #currentTurn {
            font-size: 40px;
        }

        .btn { 
            padding: 12px 24px; 
            margin: 0 10px 10px 0;
            transition: background-color 1.5s ease, border-color 1.5s ease; 
            cursor: pointer;
            border: none;
            border-radius: 6px;
            color: white;
            min-width: 150px; /* å›ºå®šæœ€å°å®½åº¦ï¼Œæ’åˆ—æ›´æ•´é½ */
        }

        #goldDisplay {
        position: absolute;
        bottom: -600px;
        left: 100px;
        font-family: Arial;
        font-size: 24px;
        color: #ffffff;
        z-index: 99;
        line-height: 1.5;
        text-shadow: 0 0 8px #000; 
        }
        #goldDisplay span {
        color: #ffff00;
        font-size: 28px;
        font-weight: bold;
        text-shadow: 0 0 8px #000; 
        }

        /* æ—¥å¿—å¯¹è¯æ¡†æ ·å¼ï¼šç§»åˆ°å³ä¾§ç½®é¡¶ï¼Œé€‚é…å°ºå¯¸ */
        #logContainer {
            position: absolute;
            top: 20px; 
            right: -1250px; 
            width: 320px; 
            height: 500px; 
            background: #482608ba;
            border: 4px solid #ffffff;
            border-radius: 8px;
            padding: 10px;
            overflow: hidden; 
        }

        /* æŒ‰é’®å®¹å™¨ */
        #btnContainer {
            position: absolute;
            top: 750px; 
            right: -750px;
            width: 600px;
            display: flex;
            gap: 8px; /* æŒ‰é’®é—´è· */
            justify-content: center; /* å±…ä¸­æ’åˆ— */
        }

        #logList {
            line-height: 24px; /* ç•¥è°ƒé«˜è¡Œé«˜ï¼Œæå‡å¯è¯»æ€§ */
            max-height: 100%;
            display: flex;
            flex-direction: column-reverse; /* æ–°æ—¥å¿—åœ¨åº•éƒ¨ï¼Œæ—§çš„å‘ä¸Šæ»š */
            overflow-y: auto; /* æ—¥å¿—è¿‡å¤šæ—¶æ˜¾ç¤ºæ»šåŠ¨æ¡ */
            scrollbar-width: thin;
            scrollbar-color: #ffd700 #482608;
        }

        /* æ—¥å¿—å•è¡Œæ ·å¼ */
        .log-item {
            color: #eee;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis; /* è¶…é•¿æ—¥å¿—çœç•¥ */
            padding: 2px 0; /* å¢åŠ å†…è¾¹è·ï¼Œé¿å…æ—¥å¿—æŒ¤åœ¨ä¸€èµ· */
        } 

        /* æŠ•é™æŒ‰é’®å®¹å™¨ */
        #surrenderBtnContainer {
            position: absolute;
            top: 700px; /* æ—¥å¿—æ é«˜åº¦500px + 20pxå†…è¾¹è· + 20pxé—´è· */
            right: -1235px; /* ä¸æ—¥å¿—æ å³åç§»ä¸€è‡´ */
            width: 320px; /* ä¸æ—¥å¿—æ å®½åº¦ä¸€è‡´ */
            display: flex;
            justify-content: center; /* æŒ‰é’®å±…ä¸­ */
        }

        /* ä¿®å¤ï¼šè‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ï¼ˆwebkitå†…æ ¸ï¼‰ */
        #logList::-webkit-scrollbar {
            width: 6px;
        }
        #logList::-webkit-scrollbar-track {
            background: #482608;
            border-radius: 3px;
        }
        #logList::-webkit-scrollbar-thumb {
            background: #ffd700;
            border-radius: 3px;
        }

        #victoryOverlay {
            position: fixed; /* å›ºå®šå®šä½ï¼Œè¦†ç›–æ•´ä¸ªè§†å£ */
            top: 0;
            left: 0;
            width: 100vw; /* è§†å£å®½åº¦100% */
            height: 100vh; /* è§†å£é«˜åº¦100% */
            pointer-events: none; /* åˆå§‹ä¸æ‹¦æˆªç‚¹å‡»ï¼Œèƒœåˆ©åæ”¹ä¸ºauto */
            opacity: 0; /* åˆå§‹é€æ˜ */
            transition: opacity 2s ease; /* 2ç§’æ¸å˜åŠ¨ç”» */
            z-index: 9999; /* æœ€é«˜å±‚çº§ï¼Œè¦†ç›–æ‰€æœ‰å…ƒç´  */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

    </style>
</head>
<body>
    <div id="gameUI">
        <div class="turn-display">å½“å‰å›åˆï¼š<span id="currentTurn">çº¢å†›</span></div>
        <div id="goldDisplay">
            <div>çº¢å†›é‡‘å¸ï¼š<span id="player1Gold">25</span></div>
            <div>è“å†›é‡‘å¸ï¼š<span id="player2Gold">25</span></div>
    </div>

        <div id="btnContainer">
            <button class="btn" id="recruitInfantry">æ‹›å‹Ÿ1æ­¥å…µ(25g)</button>
            <button class="btn" id="recruitCavalry">æ‹›å‹Ÿ1éª‘å…µ(40g)</button>
            <button class="btn" id="recruitArcher">æ‹›å‹Ÿ1ç‚®å…µ(35g)</button>
            <button class="btn" id="endTurnBtn">ç»“æŸå›åˆ</button>
        </div>

        <div id="surrenderBtnContainer">
            <button class="btn" id="surrenderBtn">æŠ•é™</button>
        </div>

        <div id="logContainer">
            <div id="logList"></div>
        </div>
    </div>

    <canvas id="gameCanvas" width="1000" height="750"></canvas>

    <div id="victoryOverlay">
        <div id="gameOverText" style="color: #fff; font-size: 72px; font-weight: bold; text-shadow: 0 0 10px #000; margin-bottom: 20px;"></div>
        <div id="victoryCampText" style="color: #fff; font-size: 48px; font-weight: bold; text-shadow: 0 0 8px #000;"></div>
    </div>
    <script>
        // ==================== å·¥å…·å‡½æ•° =================
        function hexToRgb(hex) {
        // å…¼å®¹ç®€å†™ï¼ˆ#faa â†’ #ffaaaaï¼‰
        const shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
        hex = hex.replace(shorthandRegex, (m, r, g, b) => r + r + g + g + b + b);
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result 
            ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) }
            : { r: 0, g: 0, b: 0 }; // å®¹é”™é»˜è®¤å€¼
        }

        // RGBå€¼è½¬åå…­è¿›åˆ¶é¢œè‰²ï¼ˆå¦‚ 255,170,170 â†’ #ffaaaaï¼‰
        function rgbToHex(r, g, b) {
            return `#${((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1)}`;
        }

        function getDarkCampColor(camp) {
        const rgb = hexToRgb(camp.color);
        // è°ƒæ·±å¤„ç†ï¼šå„é€šé“å€¼Ã—0.7
        const darkR = Math.max(0, Math.round(rgb.r * 0.7));
        const darkG = Math.max(0, Math.round(rgb.g * 0.7));
        const darkB = Math.max(0, Math.round(rgb.b * 0.7));
        return rgbToHex(darkR, darkG, darkB);
}

        // ===================== æ ¸å¿ƒé…ç½®ä¸å¸¸é‡ =====================
        const HEX_SIZE = 30; // å…­è¾¹å½¢è¾¹é•¿
        const HEX_WIDTH = Math.sqrt(3) * HEX_SIZE;
        const HEX_HEIGHT = 2 * HEX_SIZE;
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        // ç»˜åˆ¶å…­è¾¹å½¢è½®å»“å‡½æ•°
        function drawHexagonOutline(ctx, centerX, centerY, size, strokeStyle, lineWidth) {
            ctx.save(); // ä¿å­˜å½“å‰ä¸Šä¸‹æ–‡çŠ¶æ€
            ctx.beginPath();
            for (let i = 0; i < 6; i++) {
                const angle = 2 * Math.PI / 6 * (i + 0.5);
                const x = centerX + size * Math.cos(angle);
                const y = centerY + size * Math.sin(angle);
                i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
            }
            ctx.closePath();

            ctx.strokeStyle = strokeStyle;
            ctx.lineWidth = lineWidth;
            ctx.stroke();

            ctx.restore(); // æ¢å¤ä¸Šä¸‹æ–‡çŠ¶æ€
        }
        // å…µç§é…ç½®ï¼ˆé”®ï¼šç±»å‹ï¼Œå€¼ï¼šå±æ€§ï¼‰
        const UNIT_CONFIG = {
            infantry: { name: 'æ­¥', hp: 120, attack: 35, speed: 2, range: 1, cost: 25, color: '#0a0a0a' },
            cavalry: { name: 'éª‘', hp: 95, attack: 45, speed: 3, range: 1, cost: 40, color: '#0a0a0a' },
            archer: { name: 'ç‚®', hp: 75, attack: 60, speed: 1, range: 2, cost: 35, color: '#0a0a0a' }
        };

        // é˜µè¥é…ç½®
        const CAMP = {
            player1: { name: 'çº¢å†›', color: '#ffaaaa', flag: 'ğŸ”´' },
            player2: { name: 'è“å†›', color: '#aaaaff', flag: 'ğŸ”µ' },
            neutral: { name: 'ä¸­ç«‹', color: '#c0c0c0', flag: 'âš«' }
        };

        // å…‹åˆ¶å…³ç³»ï¼ˆæ”»å‡»æ–¹ç±»å‹ => è¢«æ”»å‡»æ–¹ç±»å‹ => ä¼¤å®³ç³»æ•°ï¼‰
        const COUNTER_RELATION = {
            infantry: { archer: 0.75, cavalry: 1.25, infantry: 1 },
            archer: { cavalry: 0.75, infantry: 1.25, archer: 1 },
            cavalry: { infantry: 0.75, archer: 1.25, cavalry: 1 }
        };

        // ===================== æ ¸å¿ƒæ•°æ®ç»“æ„ =====================
        // 1. åœ°å—ç±»
        class HexTile {
            constructor(q, r) {
                this.q = q; // è½´å‘åæ ‡q
                this.r = r; // è½´å‘åæ ‡r
                this.s = -q - r; // è½´å‘åæ ‡sï¼ˆq + r + s = 0ï¼‰
                this.camp = CAMP.neutral; // æ‰€å±è¡Œæ”¿åŒºé˜µè¥ï¼ˆåˆå§‹ä¸­ç«‹ï¼‰
                this.isCity = false; // æ˜¯å¦ä¸ºåŸå¸‚åœ°å—
                this.districtId = 0; // æ‰€å±è¡Œæ”¿åŒºIDï¼ˆ0:ä¸­ç«‹åŒºï¼Œ1:çº¢å†›åŒºï¼Œ2:è“å†›åŒºï¼Œ3:ä¸Šä¸­ç«‹åŒºï¼Œ4:ä¸‹ä¸­ç«‹åŒºï¼‰
                this.unit = null; // åœ°å—ä¸Šçš„éƒ¨é˜Ÿï¼ˆnullä¸ºç©ºï¼‰

                // é¢œè‰²æ¸å˜æ ¸å¿ƒå±æ€§
                this.targetColor = this.camp.color; // æ¸å˜ç›®æ ‡è‰²
                this.currentColor = this.camp.color; // å½“å‰æ˜¾ç¤ºè‰²ï¼ˆæ¸å˜ä¸­åŠ¨æ€æ›´æ–°ï¼‰
                this.fadeDuration = 1500; // æ¸å˜æ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰
                this.fadeStartTime = null; // æ¸å˜å¼€å§‹æ—¶é—´æˆ³ï¼ˆnull=æ— æ¸å˜ï¼‰
                
                // è½´å‘åæ ‡è½¬å±å¹•åæ ‡å…¬å¼
                this.x = (canvas.width / 2 ) + HEX_WIDTH * (q + r * 0.5);
                this.y = canvas.height / 2 + (3/2 * HEX_SIZE) * r;
            }

            // å¸¦æ¸å˜çš„é˜µè¥è®¾ç½®æ–¹æ³•
            setCampWithFade(newCamp) {
                this.camp = newCamp; // æ›´æ–°é˜µè¥
                this.targetColor = newCamp.color; // è®¾ç½®æ¸å˜ç›®æ ‡è‰²
                this.fadeStartTime = Date.now(); // è®°å½•æ¸å˜å¼€å§‹æ—¶é—´
            }

            // æ¯å¸§æ›´æ–°æ¸å˜é¢œè‰²ï¼ˆæ¸²æŸ“å‰è°ƒç”¨ï¼‰
            updateFadeColor() {
                if (!this.fadeStartTime) return; // æ— æ¸å˜ï¼Œç›´æ¥è¿”å›

                const now = Date.now(); // å½“å‰æ—¶é—´æˆ³
                const elapsed = now - this.fadeStartTime; // å·²æµé€æ—¶é—´
                const progress = Math.min(elapsed / this.fadeDuration, 1); // æ¸å˜è¿›åº¦ï¼ˆ0~1ï¼‰

                // è§£æå½“å‰è‰²å’Œç›®æ ‡è‰²çš„RGB
                const startRgb = hexToRgb(this.currentColor);
                const targetRgb = hexToRgb(this.targetColor);

                // RGBä¸‰é€šé“æ’å€¼ï¼Œé€å¸§è®¡ç®—ä¸­é—´è‰²
                const interpolatedRgb = {
                    r: startRgb.r + (targetRgb.r - startRgb.r) * progress,
                    g: startRgb.g + (targetRgb.g - startRgb.g) * progress,
                    b: startRgb.b + (targetRgb.b - startRgb.b) * progress
                };

                // æ›´æ–°å½“å‰æ˜¾ç¤ºè‰²ï¼ˆå–æ•´é¿å…æ— æ•ˆå€¼ï¼‰
                this.currentColor = rgbToHex(
                    Math.round(interpolatedRgb.r),
                    Math.round(interpolatedRgb.g),
                    Math.round(interpolatedRgb.b)
                );

                // æ¸å˜å®Œæˆï¼šæ¸…ç©ºå¼€å§‹æ—¶é—´ï¼Œç»“æŸæ’å€¼
                if (progress >= 1) {
                    this.fadeStartTime = null;
                }
            }

            // ç»˜åˆ¶å…­è¾¹å½¢åœ°å—
            draw() {
                // ç»˜åˆ¶å…­è¾¹å½¢è½®å»“
                drawHexagonOutline(ctx, this.x, this.y, HEX_SIZE, 'transparent', 0);

                // å¡«å……è¡Œæ”¿åŒºé¢œè‰²
                ctx.fillStyle = this.currentColor;
                ctx.fill();

                if (gameState.hoveredTile === this ) {
                    // æ‚¬åœæ—¶åŠ ä¸€å±‚åŠé€æ˜é«˜äº®ï¼ˆä¸è¦†ç›–åŸæœ‰é¢œè‰²ï¼‰
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.2)';
                    ctx.fill();
                    // æ‚¬åœè¾¹æ¡†åŠ ç²—+é«˜äº®è‰²
                    drawHexagonOutline(ctx, this.x, this.y, HEX_SIZE, '#ffff00', 2);
                }

                // ç»˜åˆ¶è¡Œæ”¿åŒºè¾¹ç•Œ
                const borderColor = '#fff';
                const borderWidth = this.isCity ? 3 : 1;
                drawHexagonOutline(ctx, this.x, this.y, HEX_SIZE, borderColor, borderWidth);

                // ç»˜åˆ¶åŸå¸‚æ˜Ÿæ ‡
                if (this.isCity) {
                    ctx.fillStyle = '#fff';
                    ctx.font = '30px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('â˜…', this.x, this.y+10);
                }

                // ç»˜åˆ¶åœ°å—ä¸Šçš„éƒ¨é˜Ÿ
                if (this.unit) this.unit.draw(this.x, this.y);
            }
        }

        // 2. éƒ¨é˜Ÿç±»
        class Unit {
            constructor(type, camp, tile, isNewRecruit = false) {
                this.type = type; // å…µç§ç±»å‹ï¼ˆinfantryæ­¥å…µ/cavalryéª‘å…µ/archerç‚®å…µï¼‰
                this.config = UNIT_CONFIG[type];
                this.camp = camp; // æ‰€å±é˜µè¥
                this.hp = this.config.hp; // å½“å‰ç”Ÿå‘½å€¼
                this.maxHp = this.config.hp; // æœ€å¤§ç”Ÿå‘½å€¼
                this.canAct = true; // æ˜¯å¦å¯è¡ŒåŠ¨ï¼ˆæ¯å›åˆé‡ç½®ï¼‰
                this.tile = tile; // æ‰€åœ¨åœ°å—
                this.movedThisTurn = false; // æ ‡è®°æœ¬å›åˆæ˜¯å¦ç§»åŠ¨è¿‡ï¼ˆéª‘å…µç‰¹æ€§ç”¨ï¼‰
                this.counterAttackCount = 0; // åå‡»æ¬¡æ•°è®¡æ•°ï¼ˆæœ€å¤š1æ¬¡ï¼‰
                this.isNewRecruit = isNewRecruit; // æ˜¯å¦ä¸ºæ–°æ‹›å‹Ÿå•ä½ï¼ˆæ–°æ‹›å‹Ÿå•ä½å½“å›åˆä¸å¯è¡ŒåŠ¨ï¼‰
                tile.unit = this; // ç»‘å®šåˆ°åœ°å—
            }

            // ç»˜åˆ¶éƒ¨é˜Ÿï¼ˆæ ‡è¯†ã€è¡€æ¡ã€é˜µè¥æ——å¸œã€å¯è¡ŒåŠ¨æ˜Ÿæ ‡ï¼ŒæŒ‰é¡ºåºç»˜åˆ¶é¿å…é®æŒ¡ï¼‰
            draw(tileX, tileY) {

                // 1. å…µç§æ ‡è¯†
                ctx.fillStyle = this.config.color;
                ctx.font = '20px Arial';
                ctx.fillText(this.config.name, tileX, tileY + 5);

                // 2. è¡€æ¡
                const hpWidth = HEX_SIZE * 1.5;
                const hpHeight = 5;
                // è¡€æ¡èƒŒæ™¯
                ctx.fillStyle = '#333';
                ctx.fillRect(tileX - hpWidth/2, tileY + HEX_SIZE/2, hpWidth, hpHeight);
                // è¡€æ¡å‰æ™¯ï¼ˆç»¿è‰²/çº¢è‰²ï¼‰
                const hpRatio = this.hp / this.maxHp;
                ctx.fillStyle = hpRatio > 0.3 ? '#4CAF50' : '#f44336';
                ctx.fillRect(tileX - hpWidth/2, tileY + HEX_SIZE/2, hpWidth * hpRatio, hpHeight);
                // ç”Ÿå‘½å€¼æ–‡å­—
                ctx.fillStyle = '#fff';
                ctx.font = '10px Arial';
                ctx.fillText(Math.round(this.hp), tileX, tileY + HEX_SIZE/2 + 12);

                // 3. é˜µè¥æ——å¸œ
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(this.camp.flag, tileX - HEX_SIZE/2 -4 , tileY + HEX_SIZE/2 + 8);
                ctx.restore(); // æ¢å¤ä¸Šä¸‹æ–‡çŠ¶æ€ï¼Œé‡ç½®textAlignç­‰å±æ€§

                // 4. å¯è¡ŒåŠ¨é—ªçƒé»„è‰²å…‰åœˆ
                if (this.canAct && this.camp === gameState.currentCamp && !this.isNewRecruit) {
                    // è®¡ç®—é—ªçƒé€æ˜åº¦ï¼šæ­£å¼¦å‡½æ•°å®ç° 0.3~0.8 é€æ˜åº¦å¾ªç¯ï¼Œå‘¨æœŸ1ç§’
                    const time = Date.now() / 1000;
                    const alpha = 0.3 + (Math.sin(time * 2 * Math.PI) + 1) / 2 * 0.5;
                    // ç»˜åˆ¶é—ªçƒçš„é»„è‰²å…­è¾¹å½¢å…‰åœˆ
                    drawHexagonOutline(
                        ctx, 
                        tileX, 
                        tileY, 
                        HEX_SIZE + 2, 
                        `rgba(255, 215, 0, ${alpha})`, // é‡‘é»„è‰²å¸¦é€æ˜åº¦
                        3 // å…‰åœˆçº¿æ¡å®½åº¦
                    );
                }
            }

            // è®¡ç®—æ”»å‡»ä¼¤å®³
            calculateDamage(targetUnit) {
                // åŸºç¡€ä¼¤å®³ = æ”»å‡»åŠ› * å…‹åˆ¶ç³»æ•°
                const counterCoeff = COUNTER_RELATION[this.type][targetUnit.type];
                let baseDmg = this.config.attack * counterCoeff;
                
                // å…‹åˆ¶å…³ç³»å¯¹åº”çš„æš´å‡»ç‡è°ƒæ•´
                let critRate = 0.2; // é»˜è®¤20%
                if (counterCoeff > 1) { // å…‹åˆ¶ç›®æ ‡
                    critRate = 0.4; // æš´å‡»ç‡æé«˜è‡³40%
                } else if (counterCoeff < 1) { // è¢«ç›®æ ‡å…‹åˆ¶
                    critRate = 0.05; // æš´å‡»ç‡é™ä½è‡³5%
                }
                
                // æš´å‡»åˆ¤å®š
                const isCrit = Math.random() < critRate;
                const critMulti = isCrit ? 1.5 : 1; // æš´å‡»ä¼¤å®³1.5å€
                
                // éª‘å…µç‰¹æ€§ï¼šç§»åŠ¨åæ”»å‡»ä¼¤å®³+10%ï¼Œä¸å¤„äºæˆ‘æ–¹è¡Œæ”¿åŒºæ—¶é¢å¤–+10%
                let moveMulti = 1;
                if (this.type === 'cavalry') {
                    if (this.movedThisTurn) {
                        moveMulti += 0.1;
                    }
                    const isOwnDistrict = (this.tile.districtId === 1 && this.camp === CAMP.player1) || 
                                          (this.tile.districtId === 2 && this.camp === CAMP.player2);
                    if (!isOwnDistrict) {
                        moveMulti += 0.1;
                    }
                }
                
                // æœ€ç»ˆä¼¤å®³è®¡ç®—
                const finalDmg = baseDmg * critMulti * moveMulti;

                // æ·»åŠ ä¼¤å®³æ–‡æœ¬åˆ°æ•°ç»„
                gameState.damageTexts.push({
                    x: targetUnit.tile.x,
                    y: targetUnit.tile.y,
                    value: finalDmg,
                    isCrit: isCrit,
                    timeLeft: 900,
                    lastUpdate: Date.now()
                });
                return { dmg: finalDmg, isCrit };
            }

            // è®¡ç®—åå‡»ä¼¤å®³
            calculateCounterDamage(attackerUnit) {
                // æ¯å›åˆæœ€å¤šè§¦å‘1æ¬¡åå‡»ï¼Œè¶…è¿‡åˆ™æ— ä¼¤å®³
                if (this.counterAttackCount >= 1 || attackerUnit.type === 'archer') {
                    return { dmg: 0, isCrit: false };
                }
                
                // åå‡»åŸºç¡€ä¼¤å®³ = æ”»å‡»åŠ› * 0.75 * å…‹åˆ¶ç³»æ•°
                const counterCoeff = COUNTER_RELATION[this.type][attackerUnit.type];
                let baseDmg = this.config.attack * 0.75 * counterCoeff;
                
                // æ­¥å…µç‰¹æ€§ï¼šå¤„äºåŸå¸‚åœ°å—ä¸Šæ—¶åå‡»æš´å‡»ç‡æå‡è‡³66%
                let critRate = 0.33; // é»˜è®¤33%
                if (this.type === 'infantry' && this.tile.isCity) {
                    critRate = 0.66; // åŸå¸‚åœ°å—æ­¥å…µåå‡»æš´å‡»ç‡66%
                }
                critRate = this.counterAttackCount === 0 ? critRate : 0;
                
                const isCrit = Math.random() < critRate;
                const critMulti = isCrit ? 1.8 : 1;
                
                // æœ€ç»ˆåå‡»ä¼¤å®³
                let finalDmg = baseDmg * critMulti;

                if (this.hp > 0) { // åªæœ‰å­˜æ´»æ—¶æ‰åå‡»
                    this.counterAttackCount++; // åå‡»è®¡æ•°+1ï¼Œè¯¥å›åˆå†…ä¸å¯å†æ¬¡è§¦å‘åå‡»
                    logMessage(`${this.camp.name}çš„${this.config.name}å…µåå‡»é€ æˆ${Math.round(finalDmg)}ä¼¤å®³${isCrit ? 'ï¼Œåå‡»æš´å‡»ï¼': ''}`);
        
                    // æ·»åŠ åå‡»ä¼¤å®³æ–‡æœ¬åˆ°æ•°ç»„
                    gameState.damageTexts.push({
                        x: attackerUnit.tile.x,
                        y: attackerUnit.tile.y,
                        value: finalDmg,
                        isCrit: isCrit,
                        timeLeft: 750,
                        lastUpdate: Date.now()
                    });
                }
                return { dmg: finalDmg, isCrit };
            }

            // å—åˆ°ä¼¤å®³
            takeDamage(dmg, attackerUnit) {
                // ç‚®å…µç‰¹æ€§ï¼šè¢«æ­¥å…µ/éª‘å…µè¿‘æˆ˜æ”»å‡»æ—¶å—åˆ°ä¼¤å®³+33%
                let finalDmg = dmg;
                if (this.type === 'archer' && ['infantry', 'cavalry'].includes(attackerUnit.type)) {
                    finalDmg = dmg * 1.33;
                }
                
                // æ­¥å…µç‰¹æ€§ï¼šå¤„äºåŸå¸‚åœ°å—æ—¶å—åˆ°ä¼¤å®³-33%
                if (this.type === 'infantry' && this.tile.isCity) {
                    finalDmg = dmg * 0.67;
                }
                
                this.hp = Math.max(0, this.hp - finalDmg);
                // å¦‚æœç”Ÿå‘½å€¼ä¸º0ï¼Œä»åœ°å—ç§»é™¤
                if (this.hp <= 0) {
                    attackerUnit.canAct = false; // æ”»å‡»åæ ‡è®°ä¸ºå·²è¡ŒåŠ¨
                    gameState.attackableTiles = [];
                    this.tile.unit = null;
                    logMessage(`${this.camp.name}çš„1æ”¯${this.config.name}å…µè¢«æ¶ˆç­`);
                    return true; // å·²æ­»äº¡
                }
                return false; // å­˜æ´»
            }

            // æ²»ç–—ç”Ÿå‘½å€¼
            heal(amount) {
                const oldHp = this.hp;
                this.hp = Math.min(this.maxHp, this.hp + amount);
                const actualHeal = this.hp - oldHp;
                
                if (actualHeal > 0) {
                    // æ·»åŠ æ²»ç–—æ–‡æœ¬åˆ°æ•°ç»„
                    gameState.healTexts.push({
                        x: this.tile.x,
                        y: this.tile.y,
                        value: actualHeal,
                        timeLeft: 1000, // 1ç§’æ˜¾ç¤ºæ—¶é—´
                        lastUpdate: Date.now()
                    });
                    return actualHeal;
                }
                return 0;
            }
        }

        // ===================== æ¸¸æˆæ ¸å¿ƒé€»è¾‘ =====================
        let gameState = {
            tiles: [], // æ‰€æœ‰åœ°å—
            currentCamp: CAMP.player1, // å½“å‰è¡ŒåŠ¨é˜µè¥
            playerGold: { player1: 25, player2: 25 }, // ç©å®¶é‡‘å¸
            selectedUnit: null, // é€‰ä¸­çš„éƒ¨é˜Ÿ
            movableTiles: [], // å¯ç§»åŠ¨åœ°å—
            attackableTiles: [], // å¯æ”»å‡»åœ°å—
            damageTexts: [], // å­˜å‚¨ä¼¤å®³æ–‡æœ¬
            healTexts: [], // å­˜å‚¨æ²»ç–—æ–‡æœ¬
            selectedCityTile: null, // é€‰ä¸­çš„æ‹›å‹ŸåŸå¸‚åœ°å—
            capturedNeutralCities: new Set(), // è®°å½•å·²é¢†å–å¥–åŠ±çš„ä¸­ç«‹åŸå¸‚
            goldTexts: [],// å­˜å‚¨é‡‘å¸è·å–æ–‡æœ¬
            hoveredTile: null, // è®°å½•é¼ æ ‡æ‚¬åœçš„åœ°å—
            gameOver: false, // æ ‡è®°æ¸¸æˆæ˜¯å¦ç»“æŸ
            victoryCamp: null, // èƒœåˆ©çš„é˜µè¥
        };

        function updateButtonColors() {
            const darkCampColor = getDarkCampColor(gameState.currentCamp);
            const originalCampColor = gameState.currentCamp.color;
            // è·å–5ä¸ªç›®æ ‡æŒ‰é’®
            const targetButtons = [
                document.getElementById('endTurnBtn'),
                document.getElementById('recruitInfantry'),
                document.getElementById('recruitCavalry'),
                document.getElementById('recruitArcher'),
                document.getElementById('surrenderBtn')
            ];
            // éå†è®¾ç½®æŒ‰é’®æ ·å¼
            targetButtons.forEach(btn => {
                if (btn) {
                    btn.style.backgroundColor = darkCampColor; // æ·±è‰²èƒŒæ™¯ï¼ˆæ¯”åœ°å—æ·±ï¼‰
                    btn.style.color = '#ffffff'; // ç™½è‰²æ–‡å­—ç¡®ä¿å¯¹æ¯”
                    btn.style.border = `2px solid ${originalCampColor}`; // åŸé˜µè¥è‰²è¾¹æ¡†å¢å¼ºè§†è§‰å…³è”
                    btn.style.outline = 'none';
                }
            });
        }

        // 1. åˆå§‹åŒ–åœ°å›¾
        function initMap() {
            gameState.tiles = [];
            // ç”Ÿæˆ5ä¸ªè¡Œæ”¿åŒºçš„å…­è¾¹å½¢ç½‘æ ¼
            const districtTiles = {
                1: [], // ç©å®¶1è¡Œæ”¿åŒºï¼ˆå·¦ä¾§ï¼‰
                2: [], // ç©å®¶2è¡Œæ”¿åŒºï¼ˆå³ä¾§ï¼‰
                0: [], // ä¸­ç«‹è¡Œæ”¿åŒºï¼ˆä¸­é—´ï¼‰
                3: [], // ä¸Šæ–¹ä¸­ç«‹è¡Œæ”¿åŒº
                4: []  // ä¸‹æ–¹ä¸­ç«‹è¡Œæ”¿åŒº
            };

            for (let q = -7; q <= 7; q++) {
                for (let r = -7; r <= 7; r++) {
                    if (Math.abs(q + r) <= 7) { // åŒæ­¥ç¼©å°èŒƒå›´é™åˆ¶
                        const tile = new HexTile(q, r);
                        // åˆ†é…è¡Œæ”¿åŒº
                        if (q < -2) { // å·¦ä¾§ï¼šçº¢å†›åŒº
                            tile.districtId = 1;
                            tile.camp = CAMP.player1;
                            tile.currentColor = CAMP.player1.color;
                            tile.targetColor = CAMP.player1.color;
                            districtTiles[1].push(tile);
                        } else if (q > 2) { // å³ä¾§ï¼šè“å†›åŒº
                            tile.districtId = 2;
                            tile.camp = CAMP.player2;
                            tile.currentColor = CAMP.player2.color;
                            tile.targetColor = CAMP.player2.color;
                            districtTiles[2].push(tile);
                        } else if (r < -3) { // ä¸Šæ–¹ï¼šä¸­ç«‹åŒº3
                            tile.districtId = 3;
                            tile.camp = CAMP.neutral;
                            tile.currentColor = CAMP.neutral.color;
                            tile.targetColor = CAMP.neutral.color;
                            districtTiles[3].push(tile);
                        } else if (r > 3) { // ä¸‹æ–¹ï¼šä¸­ç«‹åŒº4
                            tile.districtId = 4;
                            tile.camp = CAMP.neutral;
                            tile.currentColor = CAMP.neutral.color;
                            tile.targetColor = CAMP.neutral.color;
                            districtTiles[4].push(tile);
                        } else { // ä¸­é—´ï¼šä¸­ç«‹åŒº0
                            tile.districtId = 0;
                            tile.camp = CAMP.neutral;
                            tile.currentColor = CAMP.neutral.color;
                            tile.targetColor = CAMP.neutral.color;
                            districtTiles[0].push(tile);
                        }
                        gameState.tiles.push(tile);
                    }
                }
            }

            updateButtonColors();
            // è®¾ç½®5åº§åŸå¸‚
            // ç©å®¶1åŸå¸‚ï¼ˆå·¦ä¾§ï¼‰
            const city1 = gameState.tiles.find(t => t.q === -5 && t.r === 0);
            if (city1) {
                city1.isCity = true;
                city1.camp = CAMP.player1;
            }
            // ç©å®¶2åŸå¸‚ï¼ˆå³ä¾§ï¼‰
            const city2 = gameState.tiles.find(t => t.q === 5 && t.r === 0);
            if (city2) {
                city2.isCity = true;
                city2.camp = CAMP.player2;
            }
            // ä¸­ç«‹åŸå¸‚ï¼ˆä¸­é—´ï¼‰
            const cityNeutral = gameState.tiles.find(t => t.q === 0 && t.r === 0);
            if (cityNeutral) {
                cityNeutral.isCity = true;
                cityNeutral.camp = CAMP.neutral;
            }
            // ä¸Šæ–¹ä¸­ç«‹åŸå¸‚
            const cityNeutral3 = gameState.tiles.find(t => t.q === 0 && t.r === -5);
            if (cityNeutral3) {
                cityNeutral3.isCity = true;
                cityNeutral3.camp = CAMP.neutral;
            }
            // ä¸‹æ–¹ä¸­ç«‹åŸå¸‚
            const cityNeutral4 = gameState.tiles.find(t => t.q === 0 && t.r === 5);
            if (cityNeutral4) {
                cityNeutral4.isCity = true;
                cityNeutral4.camp = CAMP.neutral;
            }

            // åˆå§‹åŒ–åˆå§‹éƒ¨é˜Ÿ
            initInitialUnits();

            // åˆå§‹åŒ–æ—¥å¿—
            logMessage('æ¸¸æˆå¼€å§‹ï¼Œçº¢å†›å…ˆæ‰‹');
            
            // ç»‘å®šæŠ•é™æŒ‰é’®äº‹ä»¶
            const surrenderBtn = document.getElementById('surrenderBtn');
            if (surrenderBtn) {
                surrenderBtn.addEventListener('click', handleSurrender);
            }
        }

        // 2. åˆå§‹åŒ–åˆå§‹éƒ¨é˜Ÿ
        function initInitialUnits() {
            // ç©å®¶1åˆå§‹éƒ¨é˜Ÿï¼ˆåŸå¸‚å‘¨å›´ï¼šæ­¥å…µã€éª‘å…µã€ç‚®å…µï¼‰
            const p1City = gameState.tiles.find(t => t.isCity && t.camp === CAMP.player1);
            if (p1City) {
                // åŸå¸‚åœ°å—ï¼šæ­¥å…µ
                new Unit('infantry', CAMP.player1, p1City, false);
                // å‘¨å›´åœ°å—ï¼šéª‘å…µï¼ˆq=-5, r=-1ï¼‰
                const cavTile1 = gameState.tiles.find(t => t.q === -5 && t.r === -1);
                if (cavTile1) new Unit('cavalry', CAMP.player1, cavTile1, false);
                // å‘¨å›´åœ°å—ï¼šç‚®å…µï¼ˆq=-5, r=1ï¼‰
                const archTile1 = gameState.tiles.find(t => t.q === -5 && t.r === 1);
                if (archTile1) new Unit('archer', CAMP.player1, archTile1, false);
            }

            // ç©å®¶2åˆå§‹éƒ¨é˜Ÿ
            const p2City = gameState.tiles.find(t => t.isCity && t.camp === CAMP.player2);
            if (p2City) {
                new Unit('infantry', CAMP.player2, p2City, false);
                const cavTile2 = gameState.tiles.find(t => t.q === 5 && t.r === -1);
                if (cavTile2) new Unit('cavalry', CAMP.player2, cavTile2, false);
                const archTile2 = gameState.tiles.find(t => t.q === 5 && t.r === 1);
                if (archTile2) new Unit('archer', CAMP.player2, archTile2, false);
            }

            // ä¸­é—´ä¸­ç«‹åŸå¸‚å‘¨å›´2æ”¯æ­¥å…µ
            const neutralCity = gameState.tiles.find(t => t.isCity && t.camp === CAMP.neutral && t.districtId === 0);
            if (neutralCity) {
                const infTile1 = gameState.tiles.find(t => t.q === 0 && t.r === 0);
                if (infTile1) new Unit('infantry', CAMP.neutral, infTile1, false);
                const infTile2 = gameState.tiles.find(t => t.q === 0 && t.r === 1);
                if (infTile2) new Unit('infantry', CAMP.neutral, infTile2, false);
            }

            // ä¸Šæ–¹ä¸­ç«‹åŸå¸‚å‘¨å›´2æ”¯æ­¥å…µ
            const neutralCity3 = gameState.tiles.find(t => t.isCity && t.districtId === 3);
            if (neutralCity3) {
                const infTile3_1 = gameState.tiles.find(t => t.q === 0 && t.r === -5);
                if (infTile3_1) new Unit('infantry', CAMP.neutral, infTile3_1, false);
                const infTile3_2 = gameState.tiles.find(t => t.q === 0 && t.r === -6);
                if (infTile3_2) new Unit('infantry', CAMP.neutral, infTile3_2, false);
            }

            // ä¸‹æ–¹ä¸­ç«‹åŸå¸‚å‘¨å›´2æ”¯æ­¥å…µ
            const neutralCity4 = gameState.tiles.find(t => t.isCity && t.districtId === 4);
            if (neutralCity4) {
                const infTile4_1 = gameState.tiles.find(t => t.q === 0 && t.r === 5);
                if (infTile4_1) new Unit('infantry', CAMP.neutral, infTile4_1, false);
                const infTile4_2 = gameState.tiles.find(t => t.q === 0 && t.r === 6);
                if (infTile4_2) new Unit('infantry', CAMP.neutral, infTile4_2, false);
            }
        }

        // 3. ç»˜åˆ¶æ¸¸æˆç”»é¢
        function renderGame() {
            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // æ›´æ–°æ‰€æœ‰åœ°å—çš„æ¸å˜é¢œè‰²
            gameState.tiles.forEach(tile => tile.updateFadeColor());
            // ç»˜åˆ¶æ‰€æœ‰åœ°å—
            gameState.tiles.forEach(tile => tile.draw());
            // ç»˜åˆ¶å¯ç§»åŠ¨/æ”»å‡»èŒƒå›´å…‰åœˆ
            drawRangeApertures();
            // ç»˜åˆ¶ä¼¤å®³æ–‡æœ¬
            drawDamageTexts();
            // ç»˜åˆ¶æ²»ç–—æ–‡æœ¬
            drawHealTexts();
            // ç»˜åˆ¶é‡‘å¸è·å–æ–‡æœ¬
            drawGoldTexts();
            // ç»˜åˆ¶å…‹åˆ¶/è¢«å…‹æç¤ºæ–‡å­—
            drawCounterText();
            
            if (gameState.selectedCityTile) {
                const tile = gameState.selectedCityTile;
                // ç»˜åˆ¶åŠé€æ˜é»„è‰²å¡«å……
                ctx.beginPath();
                for (let i = 0; i < 6; i++) {
                    const angle = 2 * Math.PI / 6 * (i + 0.5);
                    const x = tile.x + HEX_SIZE * Math.cos(angle);
                    const y = tile.y + HEX_SIZE * Math.sin(angle);
                    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
                }
                ctx.closePath();
                ctx.fillStyle = 'rgba(255, 255, 0, 0.3)'; // é»„è‰²åŠé€æ˜
                ctx.fill();
                
                for (let i = 0; i < 6; i++) {
                    const angle = 2 * Math.PI / 6 * (i + 0.5);
                    const x = tile.x + HEX_SIZE * Math.cos(angle);
                    const y = tile.y + HEX_SIZE * Math.sin(angle);
                    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
                }
                ctx.closePath();
                ctx.strokeStyle = '#ffff00'; // é»„è‰²é«˜äº®
                ctx.lineWidth = 3;
                ctx.stroke();
            }

            // ========== é€‰ä¸­éƒ¨é˜Ÿåœ°å—çš„é»„è‰²åŠé€æ˜é«˜äº® ==========
            if (gameState.selectedUnit) {
                const tile = gameState.selectedUnit.tile;
                // 1. ç»˜åˆ¶åŠé€æ˜é»„è‰²å¡«å……
                ctx.beginPath();
                for (let i = 0; i < 6; i++) {
                    const angle = 2 * Math.PI / 6 * (i + 0.5);
                    const x = tile.x + HEX_SIZE * Math.cos(angle);
                    const y = tile.y + HEX_SIZE * Math.sin(angle);
                    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
                }
                ctx.closePath();
                ctx.fillStyle = 'rgba(255, 255, 0, 0.3)'; // é»„è‰²åŠé€æ˜
                ctx.fill();
        
                // 2. ç»˜åˆ¶é»„è‰²é«˜äº®è¾¹æ¡†ï¼ˆä¸é€‰ä¸­åŸå¸‚æ ·å¼ä¸€è‡´ï¼‰
                ctx.beginPath();
                for (let i = 0; i < 6; i++) {
                    const angle = 2 * Math.PI / 6 * (i + 0.5);
                    const x = tile.x + (HEX_SIZE + 4) * Math.cos(angle);
                    const y = tile.y + (HEX_SIZE + 4) * Math.sin(angle);
                    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
                }
                ctx.closePath();
                ctx.strokeStyle = '#ffff00'; // é»„è‰²è¾¹æ¡†
                ctx.lineWidth = 3;
                ctx.stroke();
            }

            // åˆ·æ–°UI
            updateUI();
            // æ£€æµ‹èƒœåˆ©æ¡ä»¶
            checkVictory();

        }

        // 4(1).ç»˜åˆ¶å…‹åˆ¶/è¢«å…‹æç¤ºæ–‡å­—
        function drawCounterText() {
            if (!gameState.selectedUnit || !gameState.selectedUnit.canAct) return;
            
            gameState.attackableTiles.forEach(tile => {
                const targetUnit = tile.unit;
                if (!targetUnit) return;
                
                const counterCoeff = COUNTER_RELATION[gameState.selectedUnit.type][targetUnit.type];
                let text = '';
                let color = '';
                
                if (counterCoeff > 1) {
                    text = 'å…‹åˆ¶â¬†';
                    color = '#00ff00';
                } else if (counterCoeff < 1) {
                    text = 'è¢«å…‹â¬‡';
                    color = '#ff0000';
                } else {
                    return; // æ— å…‹åˆ¶å…³ç³»ä¸æ˜¾ç¤º
                }
                
                // ç»˜åˆ¶æç¤ºæ–‡å­—
                ctx.fillStyle = color;
                ctx.font = '16px Arial bold';
                ctx.textAlign = 'center';
                ctx.shadowColor = '#000';
                ctx.shadowBlur = 2;
                ctx.fillText(text, tile.x, tile.y - HEX_SIZE - 6);
                ctx.shadowBlur = 0;
            });
        }

        // 4(2). ç»˜åˆ¶å¯ç§»åŠ¨/æ”»å‡»èŒƒå›´å…‰åœˆ + é«˜äº®
        function drawRangeApertures() {
            if (!gameState.selectedUnit || !gameState.selectedUnit.canAct || gameState.selectedUnit.isNewRecruit) return;
    
            // å¯ç§»åŠ¨åœ°å—ï¼šé’è“è‰²é«˜äº® + é†’ç›®å…‰åœˆ
            if (!gameState.selectedUnit.movedThisTurn) {
                gameState.movableTiles.forEach(tile => {
                    // 1. ç»˜åˆ¶åŠé€æ˜é«˜äº®å¡«å……
                    ctx.beginPath();
                    for (let i = 0; i < 6; i++) {
                        const angle = 2 * Math.PI / 6 * (i + 0.5);
                        const x = tile.x + HEX_SIZE * Math.cos(angle);
                        const y = tile.y + HEX_SIZE * Math.sin(angle);
                        i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
                    }
                    ctx.closePath();
                    ctx.fillStyle =  'rgba(0, 255, 255, 0.2)'; // é’è“è‰²åŠé€æ˜é«˜äº®
                    ctx.fill();

                    // 2. ç»˜åˆ¶æ›´é†’ç›®çš„å¯ç§»åŠ¨å…‰åœˆ
                    ctx.beginPath();
                    for (let i = 0; i < 6; i++) {
                        const angle = 2 * Math.PI / 6 * (i + 0.5);
                        const x = tile.x + HEX_SIZE * Math.cos(angle);
                        const y = tile.y + HEX_SIZE * Math.sin(angle);
                        i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
                    }
                    ctx.closePath();
                    ctx.strokeStyle = '#00ffffcc'; // æé«˜ä¸é€æ˜åº¦ï¼Œæ›´æ¸…æ™°
                    ctx.lineWidth = 2; // åŠ ç²—çº¿æ¡
                    ctx.stroke();
                });
            }

            // å¯æ”»å‡»åœ°å—ï¼šçº¢è‰²é«˜äº® + é†’ç›®å…‰åœˆ
            gameState.attackableTiles.forEach(tile => {
                // 1. ç»˜åˆ¶åŠé€æ˜é«˜äº®å¡«å……
                ctx.beginPath();
                for (let i = 0; i < 6; i++) {
                    const angle = 2 * Math.PI / 6 * (i + 0.5);
                    const x = tile.x + HEX_SIZE * Math.cos(angle);
                    const y = tile.y + HEX_SIZE * Math.sin(angle);
                    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
                }
                ctx.closePath();
                ctx.fillStyle = 'rgba(255, 0, 0, 0.2)'; // çº¢è‰²åŠé€æ˜é«˜äº®
                ctx.fill();

                // 2. ç»˜åˆ¶æ›´é†’ç›®çš„å¯æ”»å‡»å…‰åœˆ
                ctx.beginPath();
                for (let i = 0; i < 6; i++) {
                    const angle = 2 * Math.PI / 6 * (i + 0.5);
                    const x = tile.x + HEX_SIZE * Math.cos(angle);
                    const y = tile.y + HEX_SIZE * Math.sin(angle);
                    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
                }
                ctx.closePath();
                ctx.strokeStyle = '#ff0000cc'; // æé«˜ä¸é€æ˜åº¦ï¼Œæ›´æ¸…æ™°
                ctx.lineWidth = 2; // åŠ ç²—çº¿æ¡
                ctx.stroke();
            });
        }

        // 4(3).ç»˜åˆ¶ä¼¤å®³æ–‡æœ¬
        function drawDamageTexts() {
            const currentTime = Date.now();
            // è¿‡æ»¤æ‰å·²è¶…æ—¶çš„æ–‡æœ¬ï¼ŒåŒæ—¶æ›´æ–°å‰©ä½™æ—¶é—´
            gameState.damageTexts = gameState.damageTexts.filter(text => {
                text.timeLeft -= currentTime - text.lastUpdate;
                text.lastUpdate = currentTime;
                if (text.timeLeft <= 0) return false;

                // ç»˜åˆ¶ä¼¤å®³æ–‡æœ¬
                ctx.fillStyle = text.isCrit ? '#ff3333' : '#ffffff'; // æš´å‡»çº¢è‰²ï¼Œæ™®é€šç™½è‰²
                ctx.font = '18px Arial bold';
                ctx.textAlign = 'center';
                ctx.shadowColor = '#000';
                ctx.shadowBlur = 3;
                // æ–‡æœ¬å†…å®¹ï¼š-æ•°å€¼ + æš´å‡»æ„Ÿå¹å·
                const textContent = `-${Math.round(text.value)}${text.isCrit ? 'ï¼' : ''}`;
                ctx.fillText(textContent, text.x, text.y - 20); // ç»˜åˆ¶åœ¨éƒ¨é˜Ÿä¸Šæ–¹20px
                ctx.shadowBlur = 0; // é‡ç½®é˜´å½±
                return true;
            });
        }

        // 4(4).ç»˜åˆ¶æ²»ç–—æ–‡æœ¬
        function drawHealTexts() {
            const currentTime = Date.now();
            // è¿‡æ»¤æ‰å·²è¶…æ—¶çš„æ–‡æœ¬ï¼ŒåŒæ—¶æ›´æ–°å‰©ä½™æ—¶é—´
            gameState.healTexts = gameState.healTexts.filter(text => {
                text.timeLeft -= currentTime - text.lastUpdate;
                text.lastUpdate = currentTime;
                if (text.timeLeft <= 0) return false;

                // ç»˜åˆ¶æ²»ç–—æ–‡æœ¬
                ctx.fillStyle = '#00ff00'; // ç»¿è‰²æ²»ç–—æ–‡å­—
                ctx.font = '18px Arial bold';
                ctx.textAlign = 'center';
                ctx.shadowColor = '#000';
                ctx.shadowBlur = 3;
                // æ–‡æœ¬å†…å®¹ï¼š+æ•°å€¼
                const textContent = `+${Math.round(text.value)}`;
                ctx.fillText(textContent, text.x, text.y - 20); // ç»˜åˆ¶åœ¨éƒ¨é˜Ÿä¸Šæ–¹20px
                ctx.shadowBlur = 0; // é‡ç½®é˜´å½±
                return true;
            });
        }

        function drawGoldTexts() {
            const currentTime = Date.now();
            // è¿‡æ»¤æ‰å·²è¶…æ—¶çš„æ–‡æœ¬ï¼ŒåŒæ—¶æ›´æ–°å‰©ä½™æ—¶é—´
            gameState.goldTexts = gameState.goldTexts.filter(text => {
                text.timeLeft -= currentTime - text.lastUpdate;
                text.lastUpdate = currentTime;
                if (text.timeLeft <= 0) return false;

                // ç»˜åˆ¶é‡‘å¸æ–‡æœ¬
                ctx.fillStyle = text.color; // æ ¹æ®ç±»å‹è®¾ç½®é¢œè‰²
                ctx.font = '18px Arial bold';
                ctx.textAlign = 'center';
                ctx.shadowColor = '#000';
                ctx.shadowBlur = 3;
                // æ–‡æœ¬å†…å®¹ï¼šÂ±æ•°å€¼gï¼ˆå¦‚+15gã€-30gï¼‰
                const textContent = `${text.prefix}${Math.round(text.value)}g`;
                ctx.fillText(textContent, text.x, text.y - 20); // ç»˜åˆ¶åœ¨åŸå¸‚/éƒ¨é˜Ÿä¸Šæ–¹20px
                ctx.shadowBlur = 0; // é‡ç½®é˜´å½±
                return true;
            });
        }


        // 5. æ›´æ–°UIï¼ˆé‡‘å¸ã€å›åˆã€æ—¥å¿—ï¼‰
        function updateUI() {
            document.getElementById('currentTurn').textContent = gameState.currentCamp.name;
            document.getElementById('currentTurn').style.color = gameState.currentCamp.color;
            document.getElementById('player1Gold').textContent = gameState.playerGold.player1;
            document.getElementById('player2Gold').textContent = gameState.playerGold.player2;
        }

        // 6. æ—¥å¿—è¾“å‡º
        let logHistory = [];

        function logMessage(msg) {
            // 1. æ·»åŠ æ–°æ—¥å¿—åˆ°æ•°ç»„å¤´éƒ¨/å°¾éƒ¨ï¼Œæ§åˆ¶æœ€å¤š20æ¡
                logHistory.push(msg);
                if (logHistory.length > 20) {
                    logHistory.shift(); // ç§»é™¤æœ€æ—§çš„æ—¥å¿—
                }

                // 2. æ¸²æŸ“æ—¥å¿—åˆ—è¡¨ï¼ˆæ–°æ—¥å¿—åœ¨åº•éƒ¨ï¼Œæ—§çš„å‘ä¸Šæ»šï¼‰
                const logList = document.getElementById('logList');
                logList.innerHTML = ''; // æ¸…ç©ºåŸæœ‰å†…å®¹
                // å€’åºæ¸²æŸ“ï¼ˆä¿è¯æ–°æ—¥å¿—åœ¨å¯¹è¯æ¡†åº•éƒ¨ï¼‰
                logHistory.slice().reverse().forEach(line => {
                    const logItem = document.createElement('div');
                    logItem.className = 'log-item';
                    logItem.textContent = line;
                    logList.appendChild(logItem);
                });

                // 3. æ§åˆ¶å°ä¿ç•™æ—¥å¿—
                console.log(msg);
        }

        // 7. ç»“æŸå›åˆé€»è¾‘
        function endTurn() {
            // 1. é‡ç½®æ‰€æœ‰éƒ¨é˜Ÿçš„å¯è¡ŒåŠ¨çŠ¶æ€ + æ­¥å…µå®ˆåŸå›è¡€
            gameState.tiles.forEach(tile => {
                if (tile.unit) {
                    // é‡ç½®æ‰€æœ‰éƒ¨é˜Ÿçš„è¡ŒåŠ¨çŠ¶æ€ï¼ˆæ— è®ºé˜µè¥ï¼‰
                    tile.unit.canAct = true;
                    tile.unit.movedThisTurn = false; // é‡ç½®ç§»åŠ¨æ ‡è®°
                    tile.unit.counterAttackCount = 0; // é‡ç½®åå‡»æ¬¡æ•°
                    tile.unit.isNewRecruit = false; // æ–°æ‹›å‹Ÿå•ä½ä¸‹ä¸€å›åˆå¯è¡ŒåŠ¨
                    
                    // æ­¥å…µå®ˆåŸå›è¡€ï¼ˆæ‰€æœ‰é˜µè¥çš„æ­¥å…µéƒ½ç”Ÿæ•ˆï¼‰
                    if (tile.unit.type === 'infantry' && tile.isCity) {
                        const healAmount = tile.unit.maxHp * 0.1; // å›å¤10%
                        const actualHeal = tile.unit.heal(healAmount);
                        if (actualHeal > 0) {
                            logMessage(`${tile.unit.camp.name}çš„æ­¥å…µé©»å®ˆåŸå¸‚å›å¤${Math.round(actualHeal)}ç”Ÿå‘½å€¼`);
                        }
                    }
                }
            });

            // 2. åŸå¸‚äº§å‡ºé‡‘å¸ï¼ˆæ¯å›åˆåˆ15ï¼‰
            const currentPlayerKey = gameState.currentCamp === CAMP.player1 ? 'player1' : 'player2';
            const currentCampCities = gameState.tiles.filter(t => t.isCity && t.camp === gameState.currentCamp);
            const cityCount = currentCampCities.length;
            gameState.playerGold[currentPlayerKey] += cityCount * 15;
            logMessage(`${gameState.currentCamp.name}å›åˆç»“æŸï¼Œæœ¬å›åˆ${gameState.currentCamp.name}åŸå¸‚äº§å‡ºå…±è®¡${cityCount * 15}é‡‘å¸`);
            // éå†æ‰€æœ‰åŸå¸‚åœ°å—æ·»åŠ é‡‘å¸è·å–æ–‡æœ¬
            currentCampCities.forEach(cityTile => {
                gameState.goldTexts.push({
                    x: cityTile.x,
                    y: cityTile.y,
                    value: 15,
                    prefix: '+',
                    color: '#ffff00', // é»„è‰²
                    timeLeft: 1000, // æŒç»­1ç§’
                    lastUpdate: Date.now()
                });
            });
            // 3. åˆ‡æ¢é˜µè¥
            gameState.currentCamp = gameState.currentCamp === CAMP.player1 ? CAMP.player2 : CAMP.player1;
            updateUI();
            logMessage(`è½®åˆ°${gameState.currentCamp.name}è¡ŒåŠ¨`);
            updateButtonColors();
            gameState.selectedUnit = null;
            gameState.movableTiles = [];
            gameState.attackableTiles = [];

            renderGame();
        }

        // 8. æ‹›å‹Ÿéƒ¨é˜Ÿ
        function recruitUnit(type) {
            const config = UNIT_CONFIG[type];
            const currentPlayerKey = gameState.currentCamp === CAMP.player1 ? 'player1' : 'player2';
            
            // æ£€æŸ¥æ˜¯å¦é€‰ä¸­äº†åŸå¸‚
            if (!gameState.selectedCityTile) {
                logMessage('é”™è¯¯ï¼šè¯·ç‚¹å‡»å·±æ–¹æ§åˆ¶çš„ç©ºåŸå¸‚åœ°å—è¿›è¡Œæ‹›å‹Ÿ');
                return;
            }
            // æ ¡éªŒé€‰ä¸­çš„åŸå¸‚æ˜¯å¦åˆæ³•ï¼ˆå·±æ–¹ã€ç©ºã€åŸå¸‚ï¼‰
            const selectedCityTile = gameState.selectedCityTile;
            if (selectedCityTile.camp !== gameState.currentCamp) {
                logMessage('é”™è¯¯ï¼šé€‰ä¸­çš„åŸå¸‚ä¸å±äºå½“å‰é˜µè¥ï¼Œæ— æ³•æ‹›å‹Ÿ');
                return;
            }
            if (selectedCityTile.unit) {
                logMessage('é”™è¯¯ï¼šé€‰ä¸­çš„åŸå¸‚åœ°å—å·²æœ‰éƒ¨é˜Ÿé©»å®ˆï¼Œæ— æ³•æ‹›å‹Ÿ');
                return;
            }
            if (!selectedCityTile.isCity) {
                logMessage('é”™è¯¯ï¼šé€‰ä¸­çš„åœ°å—ä¸æ˜¯åŸå¸‚ï¼Œæ— æ³•æ‹›å‹Ÿ');
                return;
            }

            // æ£€æŸ¥é‡‘å¸æ˜¯å¦è¶³å¤Ÿ
            if (gameState.playerGold[currentPlayerKey] < config.cost) {
                logMessage(`é”™è¯¯ï¼šé‡‘å¸ä¸è¶³`);
                return;
            }

            // ç›´æ¥ä½¿ç”¨é€‰ä¸­çš„åŸå¸‚åœ°å—ç”Ÿæˆéƒ¨é˜Ÿï¼ˆæ–°æ‹›å‹Ÿå•ä½å½“å›åˆä¸å¯è¡ŒåŠ¨ï¼‰
            gameState.playerGold[currentPlayerKey] -= config.cost;
            new Unit(type, gameState.currentCamp, selectedCityTile, true);
            logMessage(`${gameState.currentCamp.name}æˆåŠŸæ‹›å‹Ÿ1${config.name}å…µï¼Œé‡‘å¸-${config.cost}`);
            gameState.selectedCityTile = null; // æ‹›å‹Ÿåå–æ¶ˆé€‰ä¸­åŸå¸‚

            gameState.goldTexts.push({
            x: selectedCityTile.x,
            y: selectedCityTile.y,
            value: config.cost,
            prefix: '-',
            color: '#cccccc', // æµ…ç°è‰²
            timeLeft: 1000, // æŒç»­1ç§’
            lastUpdate: Date.now()
            });
        }

        // 9.èƒœåˆ©æ¡ä»¶æ£€æµ‹å‡½æ•°
        function checkVictory() {
            if (gameState.gameOver) return;

            const player1Districts = new Set();
            const player2Districts = new Set();
  
            gameState.tiles.forEach(tile => {
                if (tile.camp === CAMP.player1) {
                player1Districts.add(tile.districtId);
                } else if (tile.camp === CAMP.player2) {
                player2Districts.add(tile.districtId);
                }
            });

            // èƒœåˆ©æ¡ä»¶ï¼šä¸€æ–¹è¡Œæ”¿åŒºæ•°ä¸º0
            if (player1Districts.size === 0) {
                gameState.gameOver = true;
                gameState.victoryCamp = CAMP.player2; // è“å†›èƒœåˆ©
                triggerVictoryEffect(); // è§¦å‘å…¨å±èƒœåˆ©æ•ˆæœ
                logMessage('è“å†›èƒœåˆ©ï¼çº¢å†›å·²æ— å¯æ§è¡Œæ”¿åŒº');
            } else if (player2Districts.size === 0) {
                gameState.gameOver = true;
                gameState.victoryCamp = CAMP.player1; // çº¢å†›èƒœåˆ©
                triggerVictoryEffect(); // è§¦å‘å…¨å±èƒœåˆ©æ•ˆæœ
                logMessage('çº¢å†›èƒœåˆ©ï¼è“å†›å·²æ— å¯æ§è¡Œæ”¿åŒº');
            }
            }

        // 10. å…¨å±èƒœåˆ©æ•ˆæœè§¦å‘å‡½æ•°
        function triggerVictoryEffect() {
            const overlay = document.getElementById('victoryOverlay');
            const gameOverText = document.getElementById('gameOverText');
            const victoryCampText = document.getElementById('victoryCampText');

            // 1. ç¦ç”¨æ•´ä¸ªé¡µé¢çš„ç‚¹å‡»ï¼ˆåŒ…æ‹¬canvasã€æŒ‰é’®ç­‰æ‰€æœ‰å…ƒç´ ï¼‰
            document.body.style.pointerEvents = 'none';
  
            // 2. è®¾ç½®é®ç½©èƒŒæ™¯è‰²ä¸ºèƒœåˆ©é˜µè¥è‰²ï¼ˆåŠé€æ˜ï¼‰
            const victoryRgb = hexToRgb(gameState.victoryCamp.color);
            overlay.style.backgroundColor = `rgba(${victoryRgb.r}, ${victoryRgb.g}, ${victoryRgb.b}, 0.8)`;
  
            // 3. è®¾ç½®æ–‡å­—å†…å®¹
            gameOverText.textContent = 'æ¸¸æˆç»“æŸ';
            victoryCampText.textContent = `${gameState.victoryCamp.name}èƒœåˆ©ï¼`;
  
            // 4. è§¦å‘æ¸å˜æ˜¾ç¤ºï¼ˆopacityä»0â†’1ï¼Œ2ç§’å®Œæˆï¼‰
            overlay.style.opacity = 1;
            overlay.style.pointerEvents = 'auto'; // é®ç½©å±‚æ‹¦æˆªç‚¹å‡»
        }

        // 11. æ”»å åŸå¸‚æ ¸å¿ƒå‡½æ•°
        function updateDistrictColor(cityTile, camp) {
            // è§¦å‘æ¡ä»¶1ï¼šå¿…é¡»æ˜¯åŸå¸‚åœ°å—
            if (!cityTile.isCity) return;
            // è§¦å‘æ¡ä»¶2ï¼šè¯¥åŸå¸‚æ‰€å±è¡Œæ”¿åŒºå½“å‰é¢œè‰²ä¸æ˜¯å·±æ–¹é˜µè¥è‰²
            if (cityTile.camp.color === camp.color) return;

            // è®°å½•åŸé˜µè¥ï¼ˆç”¨äºæ å¤ºé€»è¾‘ï¼‰
            const oldCamp = cityTile.camp;
            // æ›´æ–°åŸå¸‚è‡ªèº«çš„é˜µè¥
            cityTile.setCampWithFade(camp);

            // ===== ä¸­ç«‹åŸå¸‚å é¢†å¥–åŠ±æœºåˆ¶  =====
            // åˆ¤æ–­æ˜¯å¦æ˜¯ã€Œåˆå§‹ä¸­ç«‹åŸå¸‚ã€ä¸”æœªé¢†å–è¿‡å¥–åŠ±
            const isNeutralCity = oldCamp === CAMP.neutral;
            const cityUniqueKey = `${cityTile.q}-${cityTile.r}`; // åŸå¸‚å”¯ä¸€æ ‡è¯†ï¼ˆåæ ‡ï¼‰
            if (isNeutralCity && !gameState.capturedNeutralCities.has(cityUniqueKey)) {
                // å¥–åŠ±15é‡‘å¸ç»™å é¢†æ–¹
                const attackerGoldKey = camp === CAMP.player1 ? 'player1' : 'player2';
                gameState.playerGold[attackerGoldKey] += 15;
                // æ ‡è®°è¯¥ä¸­ç«‹åŸå¸‚å·²é¢†å–å¥–åŠ±ï¼Œé¿å…é‡å¤è§¦å‘
                gameState.capturedNeutralCities.add(cityUniqueKey);
            }
            // æ—¥å¿—æç¤ºå¥–åŠ±ä¿¡æ¯
            logMessage(`${camp.name}å é¢†ä¸­ç«‹åŸå¸‚(${cityTile.q},${cityTile.r})ï¼Œé‡‘å¸+15`);

            // ===== æ å¤ºæœºåˆ¶  =====
            // å®ˆåŸæ–¹ï¼ˆåŸåŸå¸‚æ§åˆ¶æ–¹ï¼‰
            const defenderCamp = cityTile.camp;
            // åŒºåˆ†ç©å®¶1/ç©å®¶2çš„é‡‘å¸é”®å
            const defenderGoldKey = defenderCamp === CAMP.player1 ? 'player1' : 'player2';
            const attackerGoldKey = camp === CAMP.player1 ? 'player1' : 'player2';
            // è®¡ç®—å®ˆåŸæ–¹åŸæ§åˆ¶çš„åŸå¸‚æ€»æ•°
            const defenderOriginalCityCount = gameState.tiles.filter(t => t.isCity && t.camp === defenderCamp).length;
            if (defenderOriginalCityCount > 0) {
                // æ å¤ºå…¬å¼ï¼š(1/å®ˆåŸæ–¹åŸåŸå¸‚æ•°)*50%*å®ˆåŸæ–¹å½“å‰é‡‘å¸ï¼Œå–æ•´
                const plunderGold = Math.floor((1 / defenderOriginalCityCount) * 0.5 * gameState.playerGold[defenderGoldKey]);
                if (plunderGold > 0) {
                    // æ”»åŸæ–¹å¢åŠ é‡‘å¸ï¼Œå®ˆåŸæ–¹å‡å°‘é‡‘å¸
                    gameState.playerGold[attackerGoldKey] += plunderGold;
                    gameState.playerGold[defenderGoldKey] -= plunderGold;
                    // æ—¥å¿—æç¤ºæ å¤ºä¿¡æ¯
                    logMessage(`${camp.name}æ”»å äº†åŸå¸‚(${cityTile.q},${cityTile.r})ï¼Œæ å¤º${defenderCamp.name}${plunderGold}é‡‘å¸`);

                    gameState.goldTexts.push({
                    x: cityTile.x,
                    y: cityTile.y,
                    value: plunderGold,
                    prefix: '+',
                    color: '#ffff00', // é»„è‰²
                    timeLeft: 1000, // æŒç»­1ç§’
                    lastUpdate: Date.now()
                    });
                }}

            // ===== æ›´æ–°æ•´ä¸ªè¡Œæ”¿åŒºçš„åœ°å—é˜µè¥/é¢œè‰² =====
            const districtId = cityTile.districtId;
            gameState.tiles.forEach(tile => {
                if (tile.districtId === districtId) {
                    tile.setCampWithFade(camp);; // æ›´æ–°è¯¥è¡Œæ”¿åŒºæ‰€æœ‰åœ°å—çš„é˜µè¥
                }
            });

            logMessage(`${camp.name}å é¢†äº†${cityTile.q},${cityTile.r}åŸå¸‚ï¼Œæ‰€å±è¡Œæ”¿åŒºå·²å½’å±${camp.name}`);
            renderGame();
        }

        // 12. åˆå§‹åŒ–è¾“å…¥äº‹ä»¶
        function initInput() {
            canvas.addEventListener('click', (e) => {
                const rect = canvas.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                const clickY = e.clientY - rect.top;

                // æ‰¾åˆ°ç‚¹å‡»çš„åœ°å—
                const clickedTile = gameState.tiles.find(tile => {
                    // å…­è¾¹å½¢ç‚¹å‡»æ£€æµ‹
                    const dx = clickX - tile.x;
                    const dy = clickY - tile.y;
                    const distance = Math.sqrt(dx*dx + dy*dy);
                    return distance <= HEX_SIZE;
                });

                // åˆ¤æ–­æ˜¯å¦ç‚¹å‡»å·±æ–¹ç©ºåŸå¸‚åœ°å—ï¼ˆæœªé€‰ä¸­éƒ¨é˜Ÿæ—¶ï¼‰
                if (clickedTile.isCity && clickedTile.camp === gameState.currentCamp && !clickedTile.unit && !gameState.selectedUnit) {
                    // é€‰ä¸­è¯¥åŸå¸‚åœ°å—,åŒæ—¶æ¸…ç©ºéƒ¨é˜Ÿé€‰ä¸­çŠ¶æ€
                    gameState.selectedUnit = null;
                    gameState.movableTiles = [];
                    gameState.attackableTiles = [];
                    gameState.selectedCityTile = clickedTile;
                    return;
                }

                // ç‚¹å‡»æœ‰å·±æ–¹å¯è¡ŒåŠ¨éƒ¨é˜Ÿçš„åœ°å— â†’ é€‰ä¸­éƒ¨é˜Ÿï¼Œæ˜¾ç¤ºå¯ç§»åŠ¨/æ”»å‡»èŒƒå›´
                else if (clickedTile.unit && clickedTile.unit.camp === gameState.currentCamp && clickedTile.unit.canAct && !clickedTile.unit.isNewRecruit) {
                    gameState.selectedCityTile = null; // å–æ¶ˆé€‰ä¸­åŸå¸‚
                    gameState.selectedUnit = clickedTile.unit;
                    // è®¡ç®—å¯ç§»åŠ¨èŒƒå›´
                    gameState.movableTiles = getMovableTiles(clickedTile.unit);
                    // è®¡ç®—å¯æ”»å‡»èŒƒå›´
                    gameState.attackableTiles = getAttackableTiles(clickedTile.unit);
                } 
                // é€‰ä¸­éƒ¨é˜Ÿåï¼Œç‚¹å‡»å¯ç§»åŠ¨åœ°å— â†’ ç§»åŠ¨éƒ¨é˜Ÿ
                else if (gameState.selectedUnit && gameState.movableTiles.includes(clickedTile) && !clickedTile.unit) {
                    moveUnit(gameState.selectedUnit, clickedTile);
                }
                // é€‰ä¸­éƒ¨é˜Ÿåï¼Œç‚¹å‡»å¯æ”»å‡»åœ°å— â†’ æ”»å‡»æ•Œäºº
                else if (gameState.selectedUnit && gameState.attackableTiles.includes(clickedTile) && clickedTile.unit) {
                    attackUnit(gameState.selectedUnit, clickedTile.unit);
                    clearselection();
                }
                else {
                    // é™¤æ­¤ä¹‹å¤–ï¼šæ¸…ç©ºæ‰€æœ‰é€‰ä¸­çŠ¶æ€
                    clearselection();
                    renderGame();
                    return;
                }

            renderGame(); // å®æ—¶åˆ·æ–°
            
            });

            canvas.addEventListener('mousemove', (e) => {
                const rect = canvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;

                // æ‰¾åˆ°é¼ æ ‡æ‚¬åœçš„åœ°å—
                gameState.hoveredTile = gameState.tiles.find(tile => {
                    const dx = mouseX - tile.x;
                    const dy = mouseY - tile.y;
                    const distance = Math.sqrt(dx*dx + dy*dy);
                    return distance <= HEX_SIZE;
                });
            });

            // ç»‘å®šæŒ‰é’®äº‹ä»¶
            document.getElementById('endTurnBtn').addEventListener('click', endTurn);
            document.getElementById('recruitInfantry').addEventListener('click', () => recruitUnit('infantry'));
            document.getElementById('recruitCavalry').addEventListener('click', () => recruitUnit('cavalry'));
            document.getElementById('recruitArcher').addEventListener('click', () => recruitUnit('archer'));
        }

        // 13. è®¡ç®—å¯ç§»åŠ¨åœ°å—å‡½æ•°
        function getMovableTiles(unit) {
            const speed = unit.config.speed;
            const startTile = unit.tile;
            // è¿”å›å‘¨å›´speedæ ¼å†…çš„ç©ºåœ°å—
            return gameState.tiles.filter(tile => {
                // è®¡ç®—å…­è¾¹å½¢è·ç¦»ï¼ˆè½´å‘åæ ‡è·ç¦»å…¬å¼ï¼‰
                const distance = (Math.abs(tile.q - startTile.q) + Math.abs(tile.r - startTile.r) + Math.abs(tile.s - startTile.s)) / 2;
                return distance <= speed && !tile.unit;
            });
        }

        // 14. è®¡ç®—å¯æ”»å‡»åœ°å—å‡½æ•°
        function getAttackableTiles(unit) {
            const range = unit.config.range;
            const startTile = unit.tile;
            // è¿”å›æ”»å‡»èŒƒå›´å†…çš„æ•Œæ–¹éƒ¨é˜Ÿåœ°å—
            return gameState.tiles.filter(tile => {
                const distance = (Math.abs(tile.q - startTile.q) + Math.abs(tile.r - startTile.r) + Math.abs(tile.s - startTile.s)) / 2;
                return distance <= range && tile.unit && tile.unit.camp !== unit.camp;
            });
        }

        // 15. ç§»åŠ¨éƒ¨é˜Ÿ
        function moveUnit(unit, targetTile) {
            // æ–°æ‹›å‹Ÿå•ä½æ— æ³•ç§»åŠ¨
            if (unit.isNewRecruit || !unit.canAct || !gameState.movableTiles.includes(targetTile) || targetTile.unit) {
                logMessage('é”™è¯¯ï¼šè¯¥éƒ¨é˜Ÿæœ¬å›åˆæ— æ³•ç§»åŠ¨');
                return;
            }
            
            // æ¸…ç©ºåŸåœ°å—çš„éƒ¨é˜Ÿ
            unit.tile.unit = null;
            // ç§»åŠ¨åˆ°æ–°åœ°å—
            unit.tile = targetTile;
            targetTile.unit = unit;
            unit.movedThisTurn = true; // æ ‡è®°æœ¬å›åˆç§»åŠ¨è¿‡

            // ç§»åŠ¨åæ¸…ç©ºå¯ç§»åŠ¨åœ°å—åˆ—è¡¨
            gameState.movableTiles = [];
            
            // ç§»åŠ¨åä¸ç«‹å³é”å®šè¡ŒåŠ¨ï¼Œå…ˆæ£€æŸ¥æ˜¯å¦æœ‰å¯æ”»å‡»ç›®æ ‡
            const newAttackableTiles = getAttackableTiles(unit);
            if (newAttackableTiles.length > 0) {
                // æœ‰å¯æ”»å‡»ç›®æ ‡ï¼Œä¿ç•™è¡ŒåŠ¨èƒ½åŠ›ï¼Œæ›´æ–°å¯æ”»å‡»èŒƒå›´
                gameState.attackableTiles = newAttackableTiles;
            } else {
                // æ— æ”»å‡»ç›®æ ‡ï¼Œé”å®šè¡ŒåŠ¨å¹¶å–æ¶ˆé€‰ä¸­ï¼Œæå‡ä½“éªŒ
                unit.canAct = false;
                clearselection();
            }

            // ç§»åŠ¨åˆ°åŸå¸‚åœ°å—ä¸”éå·±æ–¹é˜µè¥ â†’ è§¦å‘å é¢†
            if (targetTile.isCity && targetTile.camp !== unit.camp) {
                updateDistrictColor(targetTile, unit.camp);
            }
        }

        // 16.æ”»å‡»å‡½æ•°
        function attackUnit(attackerUnit, targetUnit) {
            if (!attackerUnit.canAct || !gameState.attackableTiles.includes(targetUnit.tile)) {
                logMessage('æ— æ³•æ”»å‡»ï¼šè¶…å‡ºèŒƒå›´æˆ–éƒ¨é˜Ÿå·²è¡ŒåŠ¨');
                return;
            }

            // æ”»å‡»è€…é€ æˆä¼¤å®³
            const attackResult = attackerUnit.calculateDamage(targetUnit);
            const isTargetDead = targetUnit.takeDamage(attackResult.dmg, attackerUnit);
            logMessage(`${attackerUnit.camp.name}çš„${attackerUnit.config.name}å…µæ”»å‡»é€ æˆ${Math.round(attackResult.dmg)}ä¼¤å®³${attackResult.isCrit ? 'ï¼ˆæš´å‡»ï¼‰' : ''}`);

            // ç›®æ ‡æœªæ­»äº¡åˆ™åˆ¤å®šåå‡»æœºåˆ¶
            if (!isTargetDead) {
                const counterResult = targetUnit.calculateCounterDamage(attackerUnit);
                if (counterResult.dmg > 0) attackerUnit.takeDamage(counterResult.dmg, targetUnit);
            } else {
                const targetTile = targetUnit.tile;
                if (attackerUnit.type !== 'archer') {
                    attackerUnit.tile.unit = null;
                    attackerUnit.tile = targetTile;
                    targetTile.unit = attackerUnit;
                    attackerUnit.canAct = false;
                    gameState.attackableTiles = [];
                } // æ­¥/éª‘å…µæ¶ˆç­æ•Œæ–¹éƒ¨é˜Ÿåç§»åŠ¨åˆ°ç›®æ ‡åœ°å—ä¸”æ— æ³•å†æ¬¡è¡ŒåŠ¨
                if (targetTile.isCity) updateDistrictColor(targetTile, attackerUnit.camp);
            }
            attackerUnit.canAct = false; // æ”»å‡»åæ ‡è®°ä¸ºå·²è¡ŒåŠ¨
            gameState.attackableTiles = [];
        }

        // 17. å¤„ç†æŠ•é™é€»è¾‘
        function handleSurrender() {
            if (gameState.gameOver) return; // æ¸¸æˆå·²ç»“æŸåˆ™ä¸å“åº”

            // 1. åˆ¤å®šæŠ•é™æ–¹å’Œèƒœåˆ©æ–¹
            const surrenderCamp = gameState.currentCamp; // å½“å‰å›åˆé˜µè¥=æŠ•é™æ–¹
            const victoryCamp = surrenderCamp === CAMP.player1 ? CAMP.player2 : CAMP.player1; // å¦ä¸€æ–¹=èƒœåˆ©æ–¹

            // 2. è®°å½•æŠ•é™æ—¥å¿—
            logMessage(`${surrenderCamp.name}é€‰æ‹©æŠ•é™ï¼Œ${victoryCamp.name}è·å¾—æœ€ç»ˆèƒœåˆ©ï¼`);

            // 3. æ›´æ–°æ¸¸æˆçŠ¶æ€
            gameState.gameOver = true;
            gameState.victoryCamp = victoryCamp;

            // 4. æ˜¾ç¤ºèƒœåˆ©å¼¹çª—
            triggerVictoryEffect();

            // 5. æ›´æ–°æŒ‰é’®æ ·å¼ï¼ˆç¦ç”¨æ‰€æœ‰æŒ‰é’®ï¼‰
            updateButtonColors();
        }

        // 18. æ¸…ç©ºé€‰ä¸­çŠ¶æ€å‡½æ•°
        function clearselection() {
            gameState.selectedUnit = null;
            gameState.selectedCityTile = null;
            gameState.movableTiles = [];
            gameState.attackableTiles = [];
            renderGame();
        }

        // æ¸¸æˆåˆå§‹åŒ–
        initMap();
        initInput();
        renderGame();
        
        // å¾ªç¯æ¸²æŸ“
        setInterval(renderGame, 30);

    </script>
</body>
</html>